<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Vue3 响应式实现 | 前路漫漫</title>
    <meta name="description" content="前路漫漫 当克己 当慎独">
    
    
    <link rel="preload" href="/assets/css/0.styles.6dd12250.css" as="style"><link rel="preload" href="/assets/js/app.0623bd66.js" as="script"><link rel="preload" href="/assets/js/2.5dd5749f.js" as="script"><link rel="preload" href="/assets/js/26.6cabc15b.js" as="script"><link rel="prefetch" href="/assets/js/10.fc6c68bf.js"><link rel="prefetch" href="/assets/js/11.ba650025.js"><link rel="prefetch" href="/assets/js/12.c6bd3826.js"><link rel="prefetch" href="/assets/js/13.65bc4a49.js"><link rel="prefetch" href="/assets/js/14.91612579.js"><link rel="prefetch" href="/assets/js/15.d9728f90.js"><link rel="prefetch" href="/assets/js/16.0cdff337.js"><link rel="prefetch" href="/assets/js/17.9b49432d.js"><link rel="prefetch" href="/assets/js/18.c6c32b37.js"><link rel="prefetch" href="/assets/js/19.d06222f2.js"><link rel="prefetch" href="/assets/js/20.8888a134.js"><link rel="prefetch" href="/assets/js/21.e7f0e2c3.js"><link rel="prefetch" href="/assets/js/22.1e32b4b7.js"><link rel="prefetch" href="/assets/js/23.2bdf04ee.js"><link rel="prefetch" href="/assets/js/24.2c3bbe4d.js"><link rel="prefetch" href="/assets/js/25.d1292960.js"><link rel="prefetch" href="/assets/js/27.0d0f2ae0.js"><link rel="prefetch" href="/assets/js/28.d8f98424.js"><link rel="prefetch" href="/assets/js/3.1a1f1fe3.js"><link rel="prefetch" href="/assets/js/4.7d273734.js"><link rel="prefetch" href="/assets/js/5.e11c7487.js"><link rel="prefetch" href="/assets/js/6.3195bf77.js"><link rel="prefetch" href="/assets/js/7.c30685e8.js"><link rel="prefetch" href="/assets/js/8.8adcad81.js"><link rel="prefetch" href="/assets/js/9.f7bc9cde.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6dd12250.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/images/logo.png" alt="前路漫漫" class="logo"> <span class="site-name can-hide">前路漫漫</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">所有博客</a></div><div class="nav-item"><a href="http://gofrontend.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人网站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/SmileSmith/Blogs" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">所有博客</a></div><div class="nav-item"><a href="http://gofrontend.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人网站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/SmileSmith/Blogs" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vue3 响应式实现</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/202101/Vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86&amp;%E5%AE%9E%E7%8E%B0.html#vue3-composition-api" class="sidebar-link">Vue3 composition-api</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/202101/Vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86&amp;%E5%AE%9E%E7%8E%B0.html#_1-reactive" class="sidebar-link">1. reactive</a></li><li class="sidebar-sub-header"><a href="/202101/Vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86&amp;%E5%AE%9E%E7%8E%B0.html#_2-effect" class="sidebar-link">2. effect</a></li><li class="sidebar-sub-header"><a href="/202101/Vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86&amp;%E5%AE%9E%E7%8E%B0.html#_3-实战看看？" class="sidebar-link">3. 实战看看？</a></li><li class="sidebar-sub-header"><a href="/202101/Vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86&amp;%E5%AE%9E%E7%8E%B0.html#_4-ref" class="sidebar-link">4. ref</a></li><li class="sidebar-sub-header"><a href="/202101/Vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86&amp;%E5%AE%9E%E7%8E%B0.html#_5-vue3-与-vue2-响应式差异" class="sidebar-link">5. vue3 与 vue2 响应式差异</a></li><li class="sidebar-sub-header"><a href="/202101/Vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86&amp;%E5%AE%9E%E7%8E%B0.html#_6-对比-react-hook" class="sidebar-link">6. 对比 react-hook</a></li></ul></li><li><a href="/202101/Vue3%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86&amp;%E5%AE%9E%E7%8E%B0.html#refenence" class="sidebar-link">Refenence</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="vue3-响应式实现"><a href="#vue3-响应式实现" class="header-anchor">#</a> Vue3 响应式实现</h1> <h2 id="vue3-composition-api"><a href="#vue3-composition-api" class="header-anchor">#</a> Vue3 composition-api</h2> <p><a href="https://juejin.cn/post/6890545920883032071" target="_blank" rel="noopener noreferrer">链接做了一夜动画，就为让大家更好的理解 Vue3 的 Composition Api<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="_1-reactive"><a href="#_1-reactive" class="header-anchor">#</a> 1. reactive</h3> <p>最基础的创建响应式数据的 api--reactive
reactive(obj) 就是 Vue2.x 中的 Vue.observable(obj)，将一个普通对象转换为 响应式对象
<img src="https://cdn.nlark.com/yuque/0/2020/png/696944/1607998968342-c91b4f6a-3b03-4937-bbfe-cbc7c90dd0b4.png#align=left&amp;display=inline&amp;height=194&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=194&amp;originWidth=764&amp;size=15809&amp;status=done&amp;style=none&amp;width=764" alt="image.png"></p> <h4 id="reactive-和-vue2-observable-的区别"><a href="#reactive-和-vue2-observable-的区别" class="header-anchor">#</a> reactive 和 vue2.observable 的区别</h4> <blockquote><p>题外话：如何让 vue3 和 vue2 并存</p></blockquote> <ul><li>应用级别共存，安装两个版本的 vue，不同应用使用不同 api</li></ul> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> i vue2@npm:vue@latest
<span class="token function">npm</span> i vue3@npm:vue@next
</code></pre></div><ul><li>组件级别共存：
<ul><li>使用抹平库将 vue2 和 vue3 的 api 互相转换：<a href="https://github.com/privatenumber/vue-2-3" target="_blank" rel="noopener noreferrer">https://github.com/privatenumber/vue-2-3<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>在 vue2 中使用 composition-api:
&gt; 题外话：vue3 相比 vue2，整体大小是增加了，但是在 tress-shaking 的作用下，会变小</li></ul></li></ul> <p><img src="https://cdn.nlark.com/yuque/0/2020/png/696944/1608011629953-243da2cf-d149-40c0-aff4-c0641234d66f.png#align=left&amp;display=inline&amp;height=240&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=312&amp;originWidth=693&amp;size=39299&amp;status=done&amp;style=none&amp;width=534" alt="image.png">
写个例子对比下：</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> vue2 <span class="token keyword">from</span> <span class="token string">'vue2'</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> reactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue3'</span><span class="token punctuation">;</span> <span class="token comment">// vue3没有默认导出</span>

<span class="token keyword">const</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> data <span class="token operator">=</span> vue2<span class="token punctuation">.</span><span class="token function">observable</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'is vue2.observable return itself'</span><span class="token punctuation">,</span> data <span class="token operator">===</span> obj<span class="token punctuation">,</span> data<span class="token punctuation">,</span> obj<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> obj3 <span class="token operator">=</span> <span class="token punctuation">{</span> a<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>obj3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'is vue3.reactive return itself'</span><span class="token punctuation">,</span> proxy <span class="token operator">===</span> obj3<span class="token punctuation">,</span> proxy<span class="token punctuation">,</span> obj3<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="reactive-使用"><a href="#reactive-使用" class="header-anchor">#</a> reactive 使用</h4> <p>首先来看下，Vue 官方文档中，对于 composition-api 的介绍的最简单的例子：
<img src="https://cdn.nlark.com/yuque/0/2020/png/696944/1608004604057-bcad0a6d-f3d7-4aec-b4b2-503bac4c8b2d.png#align=left&amp;display=inline&amp;height=268&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=268&amp;originWidth=772&amp;size=22961&amp;status=done&amp;style=none&amp;width=772" alt="image.png"></p> <ol><li>调用 reactive：构建 1 个响应式对象，基于之前的了解，这里应该是用 Proxy 劫持了对象的 get、set</li> <li>reactive 时对 state 定义：在 get 中做“副作用”的收集，然后在 set 中取出来，并“消费”这些“副作用”</li> <li>调用 watchEffect：注册 1 个副作用，并在注册的同时触发 state 的 get</li></ol> <h4 id="reactive-思路"><a href="#reactive-思路" class="header-anchor">#</a> reactive 思路</h4> <p><img src="https://cdn.nlark.com/yuque/0/2020/png/696944/1608129062223-f67b04b4-1328-4523-a46b-75a8e4538505.png#align=left&amp;display=inline&amp;height=428&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=428&amp;originWidth=729&amp;size=33304&amp;status=done&amp;style=none&amp;width=729" alt="image.png"></p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">reactive</span><span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isReactive</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">createReactiveObj</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">isReactive</span><span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token operator">!</span><span class="token operator">!</span>target<span class="token punctuation">.</span>__isRective<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createReactiveObj</span><span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        <span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> res <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 先占个坑位</span>
            <span class="token comment">// track(target, 'get', key)</span>
            <span class="token keyword">return</span> res<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> oldValue <span class="token operator">=</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> hadKey <span class="token operator">=</span> Object<span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">hasOwnProperty</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">const</span> result <span class="token operator">=</span> Reflect<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> receiver<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hadKey<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 先占个坑位</span>
                <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'add'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>oldValue <span class="token operator">!==</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// 先占个坑位</span>
                <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token string">'set'</span><span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> oldValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> result<span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    proxy<span class="token punctuation">.</span>__isRective <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> proxy<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-effect"><a href="#_2-effect" class="header-anchor">#</a> 2. effect</h3> <p>在函数式编程的语境中，这个 effect 可以理解为副作用。
可以这么理解：修改了某个数据，但是触发了视图更新，这不是修改数据的预期。</p> <h4 id="watcheffect"><a href="#watcheffect" class="header-anchor">#</a> watchEffect</h4> <p><img src="https://cdn.nlark.com/yuque/0/2020/png/696944/1608004604057-bcad0a6d-f3d7-4aec-b4b2-503bac4c8b2d.png#align=left&amp;display=inline&amp;height=268&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=268&amp;originWidth=772&amp;size=22961&amp;status=done&amp;style=none&amp;width=772" alt="image.png"></p> <ol><li>watchEffect 观察一个 effect，调用 effect</li> <li>effect 先标记当前 effect 为 activeEffect，然后调用 fn</li> <li>在 fn 执行过程中，会触发 fn 中 reactive 化对象的 get</li> <li>在 get 中调用 track，track 函数中收集 effect ，要收集的 effect 就是步骤 2 中的 activeEffect，并存储到对应 target[key] 的 effect 中</li></ol> <h4 id="effect-收集"><a href="#effect-收集" class="header-anchor">#</a> effect 收集</h4> <p><img src="https://cdn.nlark.com/yuque/0/2020/png/696944/1608129769908-ec330dd1-f600-46b8-8e75-1aa0b58adc5c.png#align=left&amp;display=inline&amp;height=492&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=492&amp;originWidth=1328&amp;size=73292&amp;status=done&amp;style=none&amp;width=1328" alt="image.png"></p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token comment">// ReactiveEffect是一个函数对象</span>
<span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">ReactiveEffect<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>
    id<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span>
    deps<span class="token operator">:</span> <span class="token builtin">Array</span><span class="token operator">&lt;</span>Dep<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token generic-function"><span class="token function">effect</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> ReactiveEffect<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> effect <span class="token operator">=</span> <span class="token function">createReactiveEffect</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> effect<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">let</span> activeEffect<span class="token operator">:</span> ReactiveEffect <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token generic-function"><span class="token function">createReactiveEffect</span><span class="token generic class-name"><span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token operator">=</span> <span class="token builtin">any</span><span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token function-variable function">fn</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> ReactiveEffect<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">effect</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">reactiveEffect</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// fn调用有可能触发reactive对象的get，进track，在track里需要将 设置target track 此effect（activeEffect）</span>
            activeEffect <span class="token operator">=</span> effect<span class="token punctuation">;</span>
            <span class="token comment">// 执行effect(fn)传入的预期有副作用的函数</span>
            <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            activeEffect <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">as</span> ReactiveEffect<span class="token punctuation">;</span>
    effect<span class="token punctuation">.</span>deps <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    effect<span class="token punctuation">.</span>id <span class="token operator">=</span> uuid<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> effect<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// ReactiveEffect的集合</span>
<span class="token keyword">type</span> <span class="token class-name">Dep</span> <span class="token operator">=</span> Set<span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token comment">// Target每个key所依赖的Dep</span>
<span class="token keyword">type</span> <span class="token class-name">KeyToDepMap</span> <span class="token operator">=</span> Map<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> Dep<span class="token operator">&gt;</span><span class="token punctuation">;</span>
<span class="token comment">// 依赖收集的缓存</span>
<span class="token keyword">const</span> targetMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap<span class="token operator">&lt;</span><span class="token builtin">any</span><span class="token punctuation">,</span> KeyToDepMap<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">track</span><span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>activeEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> targetAllKeyDepsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>targetAllKeyDepsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        targetMap<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token punctuation">(</span>targetAllKeyDepsMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> keyDepsSet <span class="token operator">=</span> targetAllKeyDepsMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>keyDepsSet<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        targetAllKeyDepsMap<span class="token punctuation">.</span><span class="token keyword">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token punctuation">(</span>keyDepsSet <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> dep <span class="token operator">=</span> keyDepsSet<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dep<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        dep<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>activeEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        activeEffect<span class="token punctuation">.</span>deps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="targetsmap-的数据结构"><a href="#targetsmap-的数据结构" class="header-anchor">#</a> targetsMap 的数据结构</h4> <p><img src="https://cdn.nlark.com/yuque/0/2020/png/696944/1608135820559-69b036b6-9f7c-4ee4-b525-cbbc99f4e822.png#align=left&amp;display=inline&amp;height=697&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=697&amp;originWidth=747&amp;size=64752&amp;status=done&amp;style=none&amp;width=747" alt="image.png"></p> <p>到这里为止，我们就已经实现了一个简易的响应式方案；</p> <ol><li>reactive 劫持</li> <li>effect 收集依赖的 effect</li></ol> <p>之后，只要 reactive 对象中某个 key 改变了，就会触发 set，那么在 set 中又是如何处理依赖的 effect 呢？</p> <blockquote><p>到这里都能想到的：通过 target 和 key 取出所有 effect，然后遍历执行即可</p></blockquote> <h4 id="effect-消费"><a href="#effect-消费" class="header-anchor">#</a> effect 消费</h4> <p><img src="https://cdn.nlark.com/yuque/0/2020/png/696944/1608130703485-e92a4a68-aaee-41ec-9c4c-7ec54b5330b7.png#align=left&amp;display=inline&amp;height=574&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=574&amp;originWidth=1305&amp;size=88942&amp;status=done&amp;style=none&amp;width=1305" alt="image.png"></p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">trigger</span><span class="token punctuation">(</span>target<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> <span class="token keyword">type</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> key<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span> <span class="token operator">|</span> <span class="token builtin">symbol</span><span class="token punctuation">,</span> value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">,</span> oldVale<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 在之前get前端收集到的target到effect的依赖</span>
    <span class="token keyword">const</span> depsMap <span class="token operator">=</span> targetMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>depsMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token comment">// 所有需要消费执行的effect</span>
    <span class="token keyword">const</span> effects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set<span class="token operator">&lt;</span>ReactiveEffect<span class="token operator">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> effectsToAdd <span class="token operator">=</span> depsMap<span class="token punctuation">.</span><span class="token keyword">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>effectsToAdd<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        effectsToAdd<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>effect <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            effects<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>effect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    effects<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>effect<span class="token operator">:</span> ReactiveEffect<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="为什么要使用-weakmap？"><a href="#为什么要使用-weakmap？" class="header-anchor">#</a> 为什么要使用 WeakMap？</h4> <p>当 proxy 代理的 key 是对象时，如果用 Map，会导致 target 没法被 GC 回收。测试代码如下</p> <div class="language-bash extra-class"><pre class="language-bash"><code>// 允许手动执行垃圾回收机制
node --expose-gc

global.gc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
// 返回 Nodejs 的内存占用情况，单位是 bytes
process.memoryUsage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> // heapUsed: <span class="token number">4640360</span> ≈ <span class="token number">4</span>.4M

<span class="token builtin class-name">let</span> map <span class="token operator">=</span> new Map<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin class-name">let</span> key <span class="token operator">=</span> new Array<span class="token punctuation">(</span><span class="token number">5</span> * <span class="token number">1024</span> * <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map.set<span class="token punctuation">(</span>key, <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
global.gc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process.memoryUsage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> // heapUsed: <span class="token number">46751472</span> 注意这里大约是 <span class="token number">44</span>.6M

key <span class="token operator">=</span> null<span class="token punctuation">;</span>
global.gc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process.memoryUsage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> // heapUsed: <span class="token number">46754648</span> ≈ <span class="token number">44</span>.6M

// 这句话其实是无用的，因为 key 已经是 null 了
map.delete<span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
global.gc<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process.memoryUsage<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> // heapUsed: <span class="token number">46755856</span> ≈ <span class="token number">44</span>.6M
</code></pre></div><h4 id="为什么要使用-reflect-做-value-的读写操作？"><a href="#为什么要使用-reflect-做-value-的读写操作？" class="header-anchor">#</a> 为什么要使用 Reflect 做 value 的读写操作？</h4> <p><a href="https://developer.mozilla.org/zh-cn/docs/web/javascript/reference/global_objects/reflect" target="_blank" rel="noopener noreferrer">https://developer.mozilla.org/zh-cn/docs/web/javascript/reference/global_objects/reflect<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <ol><li>ES 标准趋势：将 Object 对象的一些明显属于语言内部的方法（比如 Object.defineProperty ），放到 Reflect 对象上；</li> <li>Reflect.set(target, key, val, receiver); 如果出错不会报异常，而是返回 false，同步栈的代码可以继续运行；</li> <li>Reflect 对象的方法与 Proxy 对象的方法一一对应，用 Proxy 的 api 搞的事情，Reflect 都有对应的实现；</li></ol> <h4 id="没有暴露-effect-的-api，什么时候调用了-effect？"><a href="#没有暴露-effect-的-api，什么时候调用了-effect？" class="header-anchor">#</a> 没有暴露 effect 的 api，什么时候调用了 effect？</h4> <p><img src="https://cdn.nlark.com/yuque/0/2020/png/696944/1608018152813-13e83b51-e978-4639-861b-89efa3905fdb.png#align=left&amp;display=inline&amp;height=1700&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=1700&amp;originWidth=3262&amp;size=714874&amp;status=done&amp;style=none&amp;width=3262" alt="image.png"></p> <h3 id="_3-实战看看？"><a href="#_3-实战看看？" class="header-anchor">#</a> 3. 实战看看？</h3> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> effect<span class="token punctuation">,</span> reactive <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./vue'</span><span class="token punctuation">;</span>

<span class="token comment">// vue3 的 reactive</span>
<span class="token keyword">const</span> obj3 <span class="token operator">=</span> <span class="token punctuation">{</span> count<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> proxy <span class="token operator">=</span> <span class="token function">reactive</span><span class="token punctuation">(</span>obj3<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'is reactive return itself'</span><span class="token punctuation">,</span> proxy <span class="token operator">===</span> obj3<span class="token punctuation">,</span> proxy<span class="token punctuation">,</span> obj3<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'is reactive return itself'</span><span class="token punctuation">,</span> proxy <span class="token operator">===</span> obj3<span class="token punctuation">,</span> proxy<span class="token punctuation">,</span> obj3<span class="token punctuation">)</span><span class="token punctuation">;</span>
obj3<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'obj3.count = 2 then obj3.count '</span><span class="token punctuation">,</span> obj3<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'obj3.count = 2 then proxy.count '</span><span class="token punctuation">,</span> proxy<span class="token punctuation">.</span>count<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">effect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">'业务原始effect调用'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    document<span class="token punctuation">.</span>body<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">proxy.count is </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>proxy<span class="token punctuation">.</span>count<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    proxy<span class="token punctuation">.</span>count <span class="token operator">=</span> <span class="token number">999</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://cdn.nlark.com/yuque/0/2020/png/696944/1608133086050-a532e555-66df-4ddd-bc29-3a4f223fee1a.png#align=left&amp;display=inline&amp;height=855&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=855&amp;originWidth=1258&amp;size=176868&amp;status=done&amp;style=none&amp;width=1258" alt="image.png"></p> <h4 id="对比-vue3-源码"><a href="#对比-vue3-源码" class="header-anchor">#</a> 对比 vue3 源码</h4> <p>官网仓库：<a href="https://github.com/vuejs/vue-next" target="_blank" rel="noopener noreferrer">https://github.com/vuejs/vue-next<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> <img src="https://cdn.nlark.com/yuque/0/2020/png/696944/1608131907695-b3cba230-4ee8-4208-8fc0-ec284c3d59c1.png#align=left&amp;display=inline&amp;height=331&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=331&amp;originWidth=599&amp;size=439356&amp;status=done&amp;style=none&amp;width=599" alt="image.png">
以下场景没有考虑：</p> <ol><li>effect 中再调用 effect 的情况: effect(() =&gt; {  state.count = 2; effect(() =&gt; { document.body.innerHtml}) })</li> <li>effect 中既触发 get 又触发 set 的情况：state.count++</li> <li>reactive 对象中出现循环引用</li> <li>reactive 没有实现深度收集依赖</li></ol> <h4 id="高效阅读源码的一种方式：单测大法"><a href="#高效阅读源码的一种方式：单测大法" class="header-anchor">#</a> 高效阅读源码的一种方式：单测大法</h4> <p>对于 Vue3 这种完善的项目，单测的覆盖率是可以信任的，如果有某段代码看不懂，可以尝试如下步骤</p> <ol><li>注释/修改该段代码</li> <li>运行对应源码文件的 单元测试用例</li> <li>找到失败的用例，看看是哪些场景下会有问题</li></ol> <p><img src="https://cdn.nlark.com/yuque/0/2020/png/696944/1608133659231-ca92ebe0-7b6e-4454-9b34-d4925322b23c.png#align=left&amp;display=inline&amp;height=693&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=693&amp;originWidth=989&amp;size=137027&amp;status=done&amp;style=none&amp;width=989" alt="image.png">
注释掉 cleanup(effect);
<img src="https://cdn.nlark.com/yuque/0/2020/png/696944/1608134004487-b661a8da-a70f-4e2c-90c3-f1d3b76f6556.png#align=left&amp;display=inline&amp;height=528&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=528&amp;originWidth=1387&amp;size=106764&amp;status=done&amp;style=none&amp;width=1387" alt="image.png">
运行结果：
<img src="https://cdn.nlark.com/yuque/0/2020/png/696944/1608133941915-f7cac6dd-d4ad-4023-b4cd-41909d21e1df.png#align=left&amp;display=inline&amp;height=1083&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=1083&amp;originWidth=1377&amp;size=266712&amp;status=done&amp;style=none&amp;width=1377" alt="image.png"></p> <h3 id="_4-ref"><a href="#_4-ref" class="header-anchor">#</a> 4. ref</h3> <p>reactive 的入参必须是 非原始基础类型（string | number | undefined | null）
<img src="https://cdn.nlark.com/yuque/0/2020/png/696944/1608134039255-a1b4daad-f001-448f-b33b-882197df64e3.png#align=left&amp;display=inline&amp;height=270&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=270&amp;originWidth=500&amp;size=14042&amp;status=done&amp;style=none&amp;width=500" alt="image.png">
所以这里引出 1 个问题：
computed 这个 API 要怎么实现？ ---- 答案是 “包一层”;</p> <ol><li>用 Class 包装一层</li> <li>只暴露 value 的属性，简化用户理解，也防止其他意外</li> <li>内部调用 track 和 trigger 处理响应式逻辑</li></ol> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">ref</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RefImpl</span><span class="token punctuation">(</span>rawValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">class</span> <span class="token class-name">RefImpl<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> _value<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">readonly</span> __v_isRef <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    <span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token keyword">private</span> _rawValue<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token function">convert</span><span class="token punctuation">(</span>_rawValue<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">get</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">track</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'get'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">set</span> <span class="token function">value</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasChanged</span><span class="token punctuation">(</span>newVal<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rawValue<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_rawValue <span class="token operator">=</span> newVal<span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>_value <span class="token operator">=</span> <span class="token function">convert</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">trigger</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token string">'set'</span><span class="token punctuation">,</span> <span class="token string">'value'</span><span class="token punctuation">,</span> newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> convert <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token builtin">unknown</span></span><span class="token operator">&gt;</span><span class="token punctuation">(</span>val<span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token constant">T</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token function">isObject</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">reactive</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">:</span> val<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">const</span> count <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 0</span>

count<span class="token punctuation">.</span>value<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>count<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 1</span>
</code></pre></div><h4 id="ref-和-reactive-对比"><a href="#ref-和-reactive-对比" class="header-anchor">#</a> ref 和 reactive 对比</h4> <p><a href="https://vue-composition-api-rfc.netlify.app/zh/#ref-vs-reactive" target="_blank" rel="noopener noreferrer">https://vue-composition-api-rfc.netlify.app/zh/#ref-vs-reactive<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h3 id="_5-vue3-与-vue2-响应式差异"><a href="#_5-vue3-与-vue2-响应式差异" class="header-anchor">#</a> 5. vue3 与 vue2 响应式差异</h3> <p><a href="https://cn.vuejs.org/v2/guide/reactivity.html" target="_blank" rel="noopener noreferrer">https://cn.vuejs.org/v2/guide/reactivity.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <ol><li>不需要在 reactive 的时候做 for ( const key in obj);</li> <li>不需要对数组和对象做过多处理</li></ol> <h3 id="_6-对比-react-hook"><a href="#_6-对比-react-hook" class="header-anchor">#</a> 6. 对比 react-hook</h3> <p><img src="https://cdn.nlark.com/yuque/0/2020/png/696944/1608173114088-534d032a-2c36-48fb-91b3-ae71411cec4d.png#align=left&amp;display=inline&amp;height=402&amp;margin=%5Bobject%20Object%5D&amp;name=image.png&amp;originHeight=402&amp;originWidth=716&amp;size=36449&amp;status=done&amp;style=none&amp;width=716" alt="image.png"></p> <p><a href="https://github.com/alibaba/hooks" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/hooks<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="refenence"><a href="#refenence" class="header-anchor">#</a> Refenence</h2> <ul><li>[1] Vue 官方组合式 API 的 RFC <a href="https://vue-composition-api-rfc.netlify.app/zh/#%E8%AE%BE%E8%AE%A1%E7%BB%86%E8%8A%82" target="_blank" rel="noopener noreferrer">https://vue-composition-api-rfc.netlify.app/zh/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>[2] ES6 系列之 WeakMap: <a href="https://segmentfault.com/a/1190000015774465" target="_blank" rel="noopener noreferrer">https://segmentfault.com/a/1190000015774465<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li>[3] Vue 源码分析: <a href="https://juejin.cn/post/6898750262614163470" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/6898750262614163470<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>)</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/SmileSmith/Blogs/edit/master/docs/202101/Vue3响应式原理&amp;实现.md" target="_blank" rel="noopener noreferrer">帮助改善此页面！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">1/16/2021, 5:21:09 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.0623bd66.js" defer></script><script src="/assets/js/2.5dd5749f.js" defer></script><script src="/assets/js/26.6cabc15b.js" defer></script>
  </body>
</html>
