<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Making Instagram.com faster: Part 3 — cache first | 前路漫漫</title>
    <meta name="description" content="前路漫漫 当克己 当慎独">
    
    
    <link rel="preload" href="/assets/css/0.styles.6dd12250.css" as="style"><link rel="preload" href="/assets/js/app.0623bd66.js" as="script"><link rel="preload" href="/assets/js/2.5dd5749f.js" as="script"><link rel="preload" href="/assets/js/17.9b49432d.js" as="script"><link rel="prefetch" href="/assets/js/10.fc6c68bf.js"><link rel="prefetch" href="/assets/js/11.ba650025.js"><link rel="prefetch" href="/assets/js/12.c6bd3826.js"><link rel="prefetch" href="/assets/js/13.65bc4a49.js"><link rel="prefetch" href="/assets/js/14.91612579.js"><link rel="prefetch" href="/assets/js/15.d9728f90.js"><link rel="prefetch" href="/assets/js/16.0cdff337.js"><link rel="prefetch" href="/assets/js/18.c6c32b37.js"><link rel="prefetch" href="/assets/js/19.d06222f2.js"><link rel="prefetch" href="/assets/js/20.8888a134.js"><link rel="prefetch" href="/assets/js/21.e7f0e2c3.js"><link rel="prefetch" href="/assets/js/22.1e32b4b7.js"><link rel="prefetch" href="/assets/js/23.2bdf04ee.js"><link rel="prefetch" href="/assets/js/24.2c3bbe4d.js"><link rel="prefetch" href="/assets/js/25.d1292960.js"><link rel="prefetch" href="/assets/js/26.6cabc15b.js"><link rel="prefetch" href="/assets/js/27.0d0f2ae0.js"><link rel="prefetch" href="/assets/js/28.d8f98424.js"><link rel="prefetch" href="/assets/js/3.1a1f1fe3.js"><link rel="prefetch" href="/assets/js/4.7d273734.js"><link rel="prefetch" href="/assets/js/5.e11c7487.js"><link rel="prefetch" href="/assets/js/6.3195bf77.js"><link rel="prefetch" href="/assets/js/7.c30685e8.js"><link rel="prefetch" href="/assets/js/8.8adcad81.js"><link rel="prefetch" href="/assets/js/9.f7bc9cde.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6dd12250.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/images/logo.png" alt="前路漫漫" class="logo"> <span class="site-name can-hide">前路漫漫</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">所有博客</a></div><div class="nav-item"><a href="http://gofrontend.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人网站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/SmileSmith/Blogs" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">所有博客</a></div><div class="nav-item"><a href="http://gofrontend.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人网站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/SmileSmith/Blogs" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Making Instagram.com faster: Part 3 — cache first</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/201911/MakingInstagramFaster/%5B%E5%AF%B9%E7%85%A7%E7%89%88%5D%E8%AE%A9Instagram.com%E5%8F%98%E5%BE%97%E6%9B%B4%E5%BF%AB%EF%BC%883%EF%BC%89.html#cache-first" class="sidebar-link">Cache first</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/201911/MakingInstagramFaster/%5B%E5%AF%B9%E7%85%A7%E7%89%88%5D%E8%AE%A9Instagram.com%E5%8F%98%E5%BE%97%E6%9B%B4%E5%BF%AB%EF%BC%883%EF%BC%89.html#缓存优先" class="sidebar-link">缓存优先</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/201911/MakingInstagramFaster/%5B%E5%AF%B9%E7%85%A7%E7%89%88%5D%E8%AE%A9Instagram.com%E5%8F%98%E5%BE%97%E6%9B%B4%E5%BF%AB%EF%BC%883%EF%BC%89.html#stay-tuned-for-part-4" class="sidebar-link">Stay tuned for part 4</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/201911/MakingInstagramFaster/%5B%E5%AF%B9%E7%85%A7%E7%89%88%5D%E8%AE%A9Instagram.com%E5%8F%98%E5%BE%97%E6%9B%B4%E5%BF%AB%EF%BC%883%EF%BC%89.html#请继续关注第四章" class="sidebar-link">请继续关注第四章</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="making-instagram-com-faster-part-3-—-cache-first"><a href="#making-instagram-com-faster-part-3-—-cache-first" class="header-anchor">#</a> Making Instagram.com faster: Part 3 — cache first</h1> <h1 id="让-instagram-com-变得更快-第三章-—-缓存优先"><a href="#让-instagram-com-变得更快-第三章-—-缓存优先" class="header-anchor">#</a> 让 Instagram.com 变得更快: 第三章 — 缓存优先</h1> <p>In recent years instagram.com has seen a lot of changes — we’ve launched stories, filters, creation tools, notifications, and direct messaging as well as a myriad of other features and enhancements. However, as the product grew, a side effect was that our web performance began to slow. Over the last year we made a conscious effort to improve this. This ongoing effort has thus far resulted in almost 50% cumulative improvement to our feed page load time. This series of blog posts will outline some of the work we’ve done that led to these improvements. In <a href="https://instagram-engineering.com/making-instagram-com-faster-part-1-62cc0c327538" target="_blank" rel="noopener noreferrer">part 1<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> we talked about prefetching data and in <a href="https://instagram-engineering.com/making-instagram-com-faster-part-2-f350c8fba0d4" target="_blank" rel="noopener noreferrer">part 2<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> we talked about improving performance by pushing data directly to the client rather than waiting for the client to request the data.</p> <p>最近这几年，instagram.com 变了很多 - 我们在 INS 中加入了 Stories、滤镜、创作工具、系统通知和消息推送等新特性和功能增强。然而，伴随着产品的不断迭代成长，一个不幸的事情发生了：我们的 web 端性能开始下降了。为处理性能下降，在最近的一年中，我们有意识地开展一些工作来提升性能。截止目前，我们的不懈努力已经让 Feed 页面加载时间减少了将近 50%。这个系列的博客文章将会讲述我们为实现这些提升所做的一些工作。在<a href="/201911/MakingInstagramFaster/[对照版]让Instagram.com变得更快（1）.html">第一章</a>中我们主要讨论异步接口和异步资源的预加载，在<a href="/201911/MakingInstagramFaster/[对照版]让Instagram.com变得更快（2）.html">第二章</a>中我们主要讨论通过服务端主动推送数据来提升性能。</p> <h2 id="cache-first"><a href="#cache-first" class="header-anchor">#</a> Cache first</h2> <h2 id="缓存优先"><a href="#缓存优先" class="header-anchor">#</a> 缓存优先</h2> <p>Since we’re already pushing data to the client at the earliest possible time in the page load — the only faster way to get data to the client would be to not have to fetch or push any data at all. We can do this using a cache-first rendering approach, though this does mean that we have to display stale feed data to users for a short period of time. With this approach, when the page is loaded, we immediately present users with a cached copy of their previous feed and stories tray, and then replace it with fresh data once it’s available.</p> <p>经过前面文章中所说的优化，向客户端推送数据的时间已经被尽可能地提前了。怎么才能让页面更快地获取到数据呢？ 唯一的思路就是不经由网络的请求和推送数据。我们可以采用缓存优先的渲染机制来实现，当然「缓存」也意味着在一定时间内用户会看到之前的页面数据。在这种实现中，一旦页面加载完成，我们会立即给用户展示之前 Feed 和 Story 的副本缓存，并且在新数据可用时覆盖旧的缓存。</p> <p><code>We use Redux to manage state on instagram.com, so at a high level the way we implemented this was to store a subset of our Redux store on the client in an indexedDB table, and then rehydrate the store when the page first loads.</code> However, because of the asynchronous nature of indexedDB access, server data fetching, and user interactions, we can run into problems where the user interacts with the cached state, but then we want to ensure that those interactions are still applied to the new state when it arrives from the server.</p> <p><code>instagram.com 是使用Redux来管理前端状态，因此我们的实现方式是，在更高层次上将一个Redux Store的子集存储到indexedDB的表中，然后在页面初始化渲染时将indexedDB缓存的数据状态 rehydrate 回store中</code>。然而，由于 indexedDB 操作、请求服务端数据、用户交互都是异步的，无法判断它们的先后顺序。因此，当用户操作影响到缓存数据时，会遇到一个问题: 我们希望能确保这些对缓存数据的改动，也同样应用在服务端返回的数据。</p> <blockquote><p>译注: rehydrate 的直译是「注水」，感觉不是很准确，这里不做翻译。更多可以参考: <a href="https://www.zhihu.com/question/66068748" target="_blank" rel="noopener noreferrer">react 中出现的&quot;hydrate&quot;这个单词到底是什么意思?<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></blockquote> <p>For example, if we were to handle caching in a naive way we could run into the following problem: We begin loading from cache and from the network concurrently and since the cached feed is ready first, we display it to the user. The user then proceeds to like a post, but once the network response for the latest feed comes back it overwrites that post with a copy that doesn’t include the like action that the user applied to the cached copy (see the diagram below).</p> <p>举个例子，如果就按原来的方式直接处理缓存的状态数据，我们会遇到这样的问题：首先，我们同时从缓存和网络加载数据，由于缓存优先的策略，因此缓存数据先渲染给用户。然后，用户对某个 feed 操作了「喜欢」。这之后一旦这个 feed 最新的网络请求返回时，它就会覆盖该 feed 的状态，被覆盖后该 feed 就不包含用户刚刚对 feed 操作的「喜欢」（请参见下图）。</p> <p><img src="/assets/img/3_1.6b1a5451.png" alt="Race conditions when the user interacts with cached data (Redux actions in green, state in grey) 用户和缓存数据交互时导致的操作被覆盖场景（Redux actions是绿色，State是灰色）"></p> <p>To solve this issue, we needed a way to apply interactions to the cached state, but also store those interactions so they can be replayed later over the new state from the server. If you’ve ever used Git or similar source control systems before, this problem might seem familiar. If we think of the cached feed state as a branch, and the server feed response as master, what we effectively want to do is to do a rebase operation, applying the commits (likes, comments etc.) from our local branch onto the head of master.</p> <p>为解决这个问题，我们需要一个新的方法，它在处理缓存状态的同时，还要缓存这些对状态的处理操作，然后在服务端返回的数据中重新执行一遍这些操作。如果你有 Git 或其它版本控制工具的经验，这看上去是不是很熟悉？如果把缓存的 feed 当作一个特性分支，把服务端的放回的 feed 当作 master 分支，那么我们要做的其实就是在 master 分支上执行 rebase 操作，把特性分支上的 commit（喜欢、评论等操作）应用到 master 分支中。</p> <p>This brings us to the following design:</p> <p>这样就有如下的设计:</p> <ul><li><p>On page load, we send a request for the new data (or wait for it to be pushed)</p></li> <li><p>Create a staged subset of the Redux state</p></li> <li><p>While the request/push is pending, we store any dispatched actions</p></li> <li><p>Once the request resolves, we apply the action with the new data and any actions that have been pending to the staged state</p></li> <li><p>When the staged state is committed, we simply replace the current state with the staged one.</p></li> <li><p>当页面加载，我们发送请求获取新数据（或等待服务端主动 push 新数据，参考第二章）</p></li> <li><p>创建 1 个暂存的 Redux State 子集</p></li> <li><p>当请求/推送未完成时，把所有已经 dispatch 的 action 存储起来</p></li> <li><p>当请求/推送求完成，新的数据把暂存的State中的数据覆盖，此时把这些存储的 action 和其它等在在暂存的State中待执行的 action 都应用到最新的数据中</p></li> <li><p>当暂存的 State 提交的时候，我们直接把当前的 State 替换成暂存的 State</p></li></ul> <p><img src="/assets/img/3_2.90ea995d.png" alt="Fixing interaction race conditions with staging (Redux actions in green, state in grey)用暂存的快照修复状态覆盖的问题（Redux actions是绿色，State是灰色）"></p> <p>By having a staging state, all the existing reducer behavior can be reused. It also keeps the staged state (which has the most recent data) separate from the current state. Also, since staging is implemented using Redux, we just need to dispatch actions to use it!</p> <p>通过维持一个暂存状态的 State，所有已经存在的 reducer 行为都可以重复使用，并将暂存 State 和最新 State 分开。另外，我们是使用 Redux 来实现暂存的，因此可以直接使用 dispatch action，非常方便。</p> <div class="language-typescript extra-class"><pre class="language-typescript"><code><span class="token keyword">function</span> <span class="token function">stagingAction</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> promise<span class="token operator">:</span> <span class="token builtin">Promise</span><span class="token operator">&lt;</span>Action<span class="token operator">&gt;</span><span class="token punctuation">)</span><span class="token operator">:</span> AsyncAction<span class="token operator">&lt;</span>State<span class="token punctuation">,</span> Action<span class="token operator">&gt;</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">stagingCommit</span><span class="token punctuation">(</span>key<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span><span class="token operator">:</span> AsyncAction<span class="token operator">&lt;</span>State<span class="token punctuation">,</span> Action<span class="token operator">&gt;</span><span class="token punctuation">;</span>
</code></pre></div><p>The staging API consists of two main functions: <code>stagingAction</code> &amp; <code>stagingCommit</code> (as well as a couple of others for handling reverts and edge cases that we won't cover here).</p> <p>暂存 API 主要包含两个方法: <code>stagingAction</code> &amp; <code>stagingCommit</code> （当然还有一些还原 State 的方法和处理边界情况的代码，这里就不展开了）</p> <p><code>stagingAction</code> accepts a promise that resolves an action to be dispatched to the staged state. It initializes the staging state and keeps track of any actions that have been dispatched since it was initialized. In the source control analogy we can think of this as creating a local branch as any actions that take place will now be queued and applied over the staged state when the new data arrives.</p> <p><code>stagingAction</code> 函数接收 1 个 Promise，这个 Promise 会 resolve 1 个要 dispatch 到暂存 State 的 action。它会初始化时暂存 State，然后保存所有已经 dispatch 的 actions。在 Git 概念里，我们可以把这个操作当作创建 1 个本地分支，因为在新数据到达前，发生的任何操作都将按顺序应用到暂存的State中。</p> <p><code>stagingCommit</code> commits the staging state to the current state. If any async actions on the staging state are pending, it will wait before committing. This is similar to a rebase in source control terms, in that we apply all our local changes (from the cache branch) on top of master (the new data from the server), leaving our local branch up to date.</p> <p><code>stagingCommit</code> 函数的作用是暂存的 State 提交到当前 State 中。如果暂存的 State 中还有其它的异步 actions 未执行完，它会一直等待。这非常像 Git 中 rebase 操作: 将所有的本地改动（从缓存的特性分支中来的改动）应用到 master 的 head 前面（服务端返回的新数据），让本地的 master 分支同时应用远程改动和本地改动，从而更新到最新。</p> <p>To enable staging, we wrap the root reducer with a reducer enhancer that handles the stagingCommit action and applies the staged actions to the new state. To use all this, we just need to dispatch the relevant actions and everything is handled for us. For example, if we want to fetch a new feed and apply it to a staged state, we can do something similar to the following:</p> <p>为了更方便地使用暂存State，我们在根级的 reducer 上封装了一个 reducer 增强器，它处理所有要暂存的 action，并将所有已暂存的 actions 应用到新的 State 中。这样我们只需要 dispatch 相关 actions 就行，其它的事情这个增强器都处理好了。举个例子，如果我们要请求 1 个新的 feed，并应用到已暂存的 State 中，我们就执行类似下面的逻辑:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">fetchAndStageFeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">stagingAction</span><span class="token punctuation">(</span>
        <span class="token string">'feed'</span><span class="token punctuation">,</span>
        <span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span> data <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">fetchFeedTimeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">{</span>
                type<span class="token operator">:</span> <span class="token constant">FEED_LOADED</span><span class="token punctuation">,</span>
                <span class="token operator">...</span>data<span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// Fetches the new feed and stages it</span>
<span class="token comment">// 请求最新的 feed 并开始暂存</span>
store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">fetchAndStageFeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// any other actions dispatched until the stagingCommit action</span>
<span class="token comment">// will be applied to the 'feed' staged state</span>
<span class="token comment">// 在此期间，任何已经 dispatched 的actions都会被应用到暂存的State中的 feed</span>
<span class="token comment">// 直到 stagingCommit 提交暂存的State</span>

<span class="token comment">// Commits staging to the current state</span>
<span class="token comment">// 将暂存的State提交到当前的State中</span>
store<span class="token punctuation">.</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token function">stagingCommit</span><span class="token punctuation">(</span><span class="token string">'feed'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Using cache-first rendering for both feed posts and the stories tray led to a 2.5% and 11% improvement in respective display done times and bought the user experience more in-line with what is available on the native iOS and android Instagram apps.</p> <p>我们对 Feed 和 Story 同时使用缓存优先渲染功能，使得页面渲染完成时间缩短了 2.5％和 11％，并且让页面更贴近原生 iOS 和 android的浏览体验。</p> <h2 id="stay-tuned-for-part-4"><a href="#stay-tuned-for-part-4" class="header-anchor">#</a> Stay tuned for part 4</h2> <h2 id="请继续关注第四章"><a href="#请继续关注第四章" class="header-anchor">#</a> 请继续关注第四章</h2> <p>In part 4 we’ll cover how we reduced the size of our codebase and improved its performance through code size and execution optimizations. If you want to learn more about this work or are interested joining one of our engineering teams, please visit our careers page, follow us on Facebook or on Twitter.</p> <p>在第4章中，我们将介绍如何减少代码大小，通过代码大小和执行优化来进一步提升性能。 如果您想了解更多有关这项工作的信息，或者有兴趣加入我们的团队，请访问我们的<a href="https://www.facebook.com/careers/jobs/?q=instagram" target="_blank" rel="noopener noreferrer">公司岗位页面<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，也可以关注我们<a href="https://www.facebook.com/instagramengineering/" target="_blank" rel="noopener noreferrer">on Facebook<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>或者<a href="https://twitter.com/instagrameng" target="_blank" rel="noopener noreferrer">on Twitter<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/SmileSmith/Blogs/edit/master/docs/201911/MakingInstagramFaster/[对照版]让Instagram.com变得更快（3）.md" target="_blank" rel="noopener noreferrer">帮助改善此页面！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">12/30/2019, 2:50:37 PM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.0623bd66.js" defer></script><script src="/assets/js/2.5dd5749f.js" defer></script><script src="/assets/js/17.9b49432d.js" defer></script>
  </body>
</html>
