(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{232:function(t,s,a){t.exports=a.p+"assets/img/7.f55bbd5e.png"},233:function(t,s,a){t.exports=a.p+"assets/img/6.7fd99528.png"},234:function(t,s,a){t.exports=a.p+"assets/img/3.947f9dac.jpg"},235:function(t,s,a){t.exports=a.p+"assets/img/4.6844779b.jpg"},236:function(t,s,a){t.exports=a.p+"assets/img/5.9998e317.jpg"},276:function(t,s,a){"use strict";a.r(s);var n=a(0),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h1",{attrs:{id:"tree-shaking进阶之路"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#tree-shaking进阶之路"}},[t._v("#")]),t._v(" Tree-Shaking进阶之路")]),t._v(" "),n("h2",{attrs:{id:"一、什么是-tree-shaking？"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#一、什么是-tree-shaking？"}},[t._v("#")]),t._v(" 一、什么是 Tree-Shaking？")]),t._v(" "),n("p",[t._v("在"),n("a",{attrs:{href:"https://webpack.js.org/guides/tree-shaking/",target:"_blank",rel:"noopener noreferrer"}},[t._v("webpack官方文档"),n("OutboundLink")],1),t._v("的定义是: Tree-Shaking 用于移除 JavaScript 上下文中的未引用代码「dead-code」。在 webpack 中，基于 ES2015 模块（也叫做 "),n("strong",[t._v("harmony")]),t._v(" 模块）的静态分析能力，确定模块之间的依赖关系，进而找出不需要的依赖，在构建阶段就删除不需要的依赖。")]),t._v(" "),n("p",[t._v("在实际业务开发中，我们往往会引入许多npm包，为了加快用户下载脚本的大小和时间，一般情况下我们都会利用 Tree-Shaking 的特性来减小打包后代码的体积。")]),t._v(" "),n("p",[n("img",{attrs:{src:a(232),alt:"01.No-Tree-Shaking"}})]),t._v(" "),n("p",[n("img",{attrs:{src:a(233),alt:"02.With-Tree-Shaking"}})]),t._v(" "),n("h2",{attrs:{id:"二、如何使用-tree-shaking？"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#二、如何使用-tree-shaking？"}},[t._v("#")]),t._v(" 二、如何使用 Tree-Shaking？")]),t._v(" "),n("ol",[n("li",[t._v("代码中使用 ESModule，在导入时使用按需导入的语法 "),n("code",[t._v("import { foo, bar } from './ESModule';")])]),t._v(" "),n("li",[t._v("webpack中没有编译器把 ESModule 转换成 CommonJSModule")]),t._v(" "),n("li",[t._v("webpack默认会进行 Tree-Shaking，标记未被使用的导出内容为 "),n("strong",[t._v("unused harmony export")])]),t._v(" "),n("li",[t._v("配置uglifyJS等webpack代码压缩插件会删掉 被webpack标记为 "),n("strong",[t._v("unused harmony export")]),t._v("的代码")])]),t._v(" "),n("p",[n("em",[t._v("// webpack@4.x中已经弃用单独配置uglifyJSPlugin的方式，第4点修改为配置mode=production")])]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// in index.js")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" foo "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("from")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./es'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// in webpack.config.js in webpack@2@3")]),t._v("\n    plugins"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("UglifyJsPlugin")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("sourceMap"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" compress"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("warnings"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// in webpack.config.js in webpack@4")]),t._v("\n    mode"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'production'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n")])])]),n("h2",{attrs:{id:"三、tree-shaking-和-commonjsmodule"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#三、tree-shaking-和-commonjsmodule"}},[t._v("#")]),t._v(" 三、Tree-Shaking 和 CommonJSModule")]),t._v(" "),n("p",[t._v("在上面已经提到: Tree-Shaking 是基于静态模块分析的，因此对于 CommonJS 规范的JS模块，Tree-Shaking 不会生效，webpack 在打包时会全量打包至 chunk 里。")]),t._v(" "),n("h2",{attrs:{id:"四、tree-shaking-和-babel，鱼和熊掌可以兼得"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#四、tree-shaking-和-babel，鱼和熊掌可以兼得"}},[t._v("#")]),t._v(" 四、Tree-Shaking 和 Babel，鱼和熊掌可以兼得")]),t._v(" "),n("p",[t._v("这里 Babel 和 Tree-Shaking 又有什么关系呢？")]),t._v(" "),n("p",[t._v("在实际的web业务中，我们很难要求用户使用完整支持ES6的浏览器，我们一般会利用 babel-loader 将ES6源码转换成浏览器可解析的JS。")]),t._v(" "),n("p",[t._v("问题的答案是 babel-preset-env 中有一项默认配置： "),n("code",[t._v("module: 'cjs'")]),t._v("。这项配置的作用是："),n("code",[t._v("babel对ESModule的转换方式")]),t._v("，默认的cjs会把源码中所有的ESModule转换成CommonJSModule！！！")]),t._v(" "),n("h3",{attrs:{id:"_4-1-babel-对-esmodule-模块的处理"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-babel-对-esmodule-模块的处理"}},[t._v("#")]),t._v(" 4.1 Babel 对 ESModule 模块的处理")]),t._v(" "),n("p",[t._v("首先，是动态模块和静态模块的问题，静态模块可以转换成动态模块，反之则不能。")]),t._v(" "),n("ul",[n("li",[t._v("static(es) --\x3e dynamic(cjs) ✅")]),t._v(" "),n("li",[t._v("dynamic(cjs) -/-> static(es) ❌")])]),t._v(" "),n("p",[t._v("babel在设计时可能考虑到了这个因素: 既然代码中可能混杂cjs和es，并且cjs不能转换成es，那就默认把所有es转换成cjs，准没错。")]),t._v(" "),n("p",[t._v("此外，babel-preset-env提供了"),n("code",[t._v("module")]),t._v("的配置，我们可以配置"),n("code",[t._v("module: false")]),t._v("，让babel不转换 ESModule，这样webpack中Tree-Shaking就可以正常工作")]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    loader"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"babel-loader"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    options"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        presets"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"env"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" modules"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stage-2"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n")])])]),n("h3",{attrs:{id:"_4-2-cjs和es混用导致-babel-transform-runtime-异常"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-cjs和es混用导致-babel-transform-runtime-异常"}},[t._v("#")]),t._v(" 4.2 cjs和es混用导致 babel-transform-runtime 异常")]),t._v(" "),n("p",[t._v("我们知道，Babel 在转换ES5以上的语法时会需要一些polyfill，比如es-class。")]),t._v(" "),n("ul",[n("li",[t._v("如果不做特别处理，Babel 会把每个class都转换成完整的ES5-class实现，产生很多冗余代码")]),t._v(" "),n("li",[t._v("如果用全局polyfill，会污染全局上下文，并且需要手动需要哪些polyfill，比较繁琐")])]),t._v(" "),n("p",[t._v("babel-transform-runtime 可以解决上面提到问题：它会在用到 es-class 的模块中 "),n("code",[t._v("import")]),t._v(" 一个公共的 class-helper 实现。这样就以最小的体积代价，只影响需要 polyfill 的JS模块。详情可阅读："),n("a",{attrs:{href:"https://babeljs.io/docs/en/babel-plugin-transform-runtime#why",target:"_blank",rel:"noopener noreferrer"}},[t._v("why babel-transfrom-runtime"),n("OutboundLink")],1)]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    loader"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"babel-loader"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    options"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        presets"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"env"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" modules"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stage-2"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        plugins"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"transform-runtime"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[n("img",{attrs:{src:a(234),alt:"polyfill"}})]),t._v(" "),n("p",[t._v("关于 Tree-Shaking 的问题在哪里？")]),t._v(" "),n("p",[t._v("当你的项目中有混用 ESModule 和 CommonJSModule 的时候，有可能触发一个配置冲突问题。在说明这个问题之间我们前置两个技术点：")]),t._v(" "),n("ol",[n("li",[t._v("上面提到，babel-transfrom-runtime 会往需要 polyfill 的模块中 "),n("strong",[t._v("导入")]),t._v(" polyfill代码。")]),t._v(" "),n("li",[t._v("现代JS编译器，对于JS模块的解析，如果代码中出现 import 或者 export，它就被当作 ESModule。在 ESModule 中 module 是保留字，不允许任何操作，比如"),n("code",[t._v("module.exports = xxx")]),t._v("会报如下错误：")])]),t._v(" "),n("div",{staticClass:"language-bash extra-class"},[n("pre",{pre:!0,attrs:{class:"language-bash"}},[n("code",[t._v("// "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" terminal wepack error: js模块错误导致模块解析错误\nWARNING "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" ./index.js\n"),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'promise'")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("imported as "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'CommonJSModule'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" was not found "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'./cjs.js'")]),t._v("\n\n// "),n("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" browser "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("open")]),t._v(" js error: 具体js错误\nCannot assign to "),n("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("read")]),t._v(" only property "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'exports'")]),t._v(" of object "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'#<Object>'")]),t._v("\n")])])]),n("p",[t._v("当满足以下条件时，transform-runtime"),n("strong",[t._v("往CommonJS模块中import导入polyfill")]),t._v("，就会出现上面的错误：")]),t._v(" "),n("ol",[n("li",[t._v("使用4.2中所示的Babel配置: "),n("code",[t._v("modules:false && babel-plugin-transform-runtime")])]),t._v(" "),n("li",[t._v("在ESModule中导入CommonJSModule的行为")]),t._v(" "),n("li",[t._v("CommonJSModule中有需要polyfill的代码（如使用ES6 class语法）")])]),t._v(" "),n("p",[t._v("分析结果是cjs和es混用的项目中，直接配置"),n("code",[t._v("modules:false")]),t._v("和"),n("code",[t._v("babel-plugin-transform-runtime")]),t._v("是有冲突的")]),t._v(" "),n("ul",[n("li",[n("p",[t._v("如果仅有"),n("code",[t._v("module:false")]),t._v("，transform-runtime往CommonJSModule中导入polyfill会使用reqire的方式，不会报错。但是会导致其它ESModule在webpack中的 Tree-Shaking 失效😢")])]),t._v(" "),n("li",[n("p",[t._v("如果仅有transform-runtime，就不会有有polyfill导入，CommonJSModule 原样输出，被webpack当作 CommonJS 模块，不会报错。但是没有 transform-runtime，想使用新的语法就得用\b全局导入 babel-polyfill 的方式😢")])])]),t._v(" "),n("p",[n("img",{attrs:{src:a(235),alt:"harmony-import"}})]),t._v(" "),n("p",[t._v("解决之法是针对ESModule和CommonJS模块分别配置babel处理的方式，详情见"),n("a",{attrs:{href:"https://github.com/babel/babel/issues/9238",target:"_blank",rel:"noopener noreferrer"}},[t._v("babel/issues/9238"),n("OutboundLink")],1)]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[t._v("rules"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    test"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/cjs\\.js$/")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    use"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        loader"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"babel-loader"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        options"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            presets"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"env"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" modules"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"commonjs"')]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stage-2"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            plugins"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"transform-runtime"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            cacheDirectory"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// CommonJS规范的使用sourceType: "script"')]),t._v("\n            sourceType"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"script"')]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    test"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/(es|index)\\.js$/")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    use"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        loader"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"babel-loader"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        options"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            presets"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"env"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" modules"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"stage-2"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            plugins"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"transform-runtime"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v('// ES规范的使用sourceType: "module"（默认值）')]),t._v("\n            sourceType"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"module"')]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n")])])]),n("p",[n("em",[t._v("// babel@7.x中可以合并配置")])]),t._v(" "),n("div",{staticClass:"language-javascript extra-class"},[n("pre",{pre:!0,attrs:{class:"language-javascript"}},[n("code",[t._v("rules"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        test"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/\\.js$/")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        exclude"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token regex"}},[t._v("/node_modules/")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        use"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                loader"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'babel-loader'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                options"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                    presets"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@babel/preset-env'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v(" modules"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                    plugins"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'@babel/plugin-transform-runtime'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n                    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// babel@7新增unambiguous")]),t._v("\n                    "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// transform-runtime可以自动识别模块类型，根据模块类型使用不同的“导入”")]),t._v("\n                    sourceType"),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"unambiguous"')]),t._v("\n                "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\n")])])]),n("h2",{attrs:{id:"五、tree-shaking-和-sideeffect，锦上添花"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#五、tree-shaking-和-sideeffect，锦上添花"}},[t._v("#")]),t._v(" 五、Tree-Shaking 和 SideEffect，锦上添花")]),t._v(" "),n("p",[t._v("SideEffect 是 webpack@v4 的重要特性之一，是 Tree-Shaking 的重要补充，可以让 webpack 更好地进行无用代码的剥离。")]),t._v(" "),n("p",[t._v("即使依赖的npm包的 package.json 中没有标记 sideEffects，Tree-Shaking 过程中也会利用"),n("a",{attrs:{href:"https://github.com/terser-js/terser",target:"_blank",rel:"noopener noreferrer"}},[t._v("terser"),n("OutboundLink")],1),t._v("来分析模中的副作用来判断哪些代码可以优化掉。然而因为JS语言天生的动态性，terser对副作用的判断很难做到非常准确，多数情况下它的工作还是表保守。因此需要编写npm包的作者自己来定义自己包中的副作用。")]),t._v(" "),n("p",[n("em",[t._v('"副作用"定义是：导入时就执行的特定行为的代码，而不是默认导出或多个命名导出。一个典型例子是polyfills，它会影响全局，但通常不在模块中导出。')])]),t._v(" "),n("p",[t._v("比如我们编写了1个Button组件，并准备发布npm包。如果确认该包下没有任何副作用的代码，就可以在 packeage.json 标记 sideEffects 为false。webpack在处理该模块时，会忽略所有非导出的内容。")]),t._v(" "),n("div",{staticClass:"language-json extra-class"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"@my-ui/Button"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"sideEffects"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("再比如我们编写了1个Layout组件，并准备发布npm包。如果确认该包下某个未被引用的 reset.css 有全局作用（副作用），就可以在 packeage.json 设置 sideEffects 值为该css文件的相对路径。webpack 在处理该模块时，会忽略非导出的内容，而该 reset.css 还会被打包进来。")]),t._v(" "),n("div",{staticClass:"language-json extra-class"},[n("pre",{pre:!0,attrs:{class:"language-json"}},[n("code",[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"name"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"@my-ui/Button"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token property"}},[t._v('"sideEffects"')]),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./reset.css"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),n("p",[t._v("更多可参考官方文档："),n("a",{attrs:{href:"https://webpack.js.org/guides/tree-shaking/#clarifying-tree-shaking-and-sideeffects",target:"_blank",rel:"noopener noreferrer"}},[t._v("clarifying-tree-shaking-and-sideeffects"),n("OutboundLink")],1)]),t._v(" "),n("h2",{attrs:{id:"六、tree-shaking-和-sourcemap，我全都要"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#六、tree-shaking-和-sourcemap，我全都要"}},[t._v("#")]),t._v(" 六、Tree-Shaking 和 SourceMap，我全都要")]),t._v(" "),n("p",[t._v("有同学要问了：如果 Tree-Shaking 把无用代码删除后，还能在SourceMap 帮助下看到相关的源码吗？")]),t._v(" "),n("p",[t._v("答案是可以的：")]),t._v(" "),n("p",[n("img",{attrs:{src:a(236),alt:"source-map"}})]),t._v(" "),n("h2",{attrs:{id:"七、web项目中使用tree-shaking的实践建议"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#七、web项目中使用tree-shaking的实践建议"}},[t._v("#")]),t._v(" 七、web项目中使用Tree-Shaking的实践建议")]),t._v(" "),n("h3",{attrs:{id:"_1-非node体系的代码尽量使用esmodule"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1-非node体系的代码尽量使用esmodule"}},[t._v("#")]),t._v(" 1. 非Node体系的代码尽量使用ESModule")]),t._v(" "),n("p",[t._v("CommonJSModule 的动态性和 ESModule 的静态特是实际应用中平衡取舍的形成的，没绝对的好坏。当然，如果你的模块只在web端使用（无node的应用场景），且没有用到动态导入、条件导入的特性，建议使用 ESModule 规范来模块化你的代码。")]),t._v(" "),n("h3",{attrs:{id:"_2-编写-esmodule-代码，有多个非强耦合的导出内容时，尽量使用命名导出-按需导入"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2-编写-esmodule-代码，有多个非强耦合的导出内容时，尽量使用命名导出-按需导入"}},[t._v("#")]),t._v(" 2. 编写 ESModule 代码，有多个非强耦合的导出内容时，尽量使用命名导出/按需导入")]),t._v(" "),n("h3",{attrs:{id:"_3-babel-配置中对-commonjs-模块特殊配置，注意babel-6和bable-7的区别"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3-babel-配置中对-commonjs-模块特殊配置，注意babel-6和bable-7的区别"}},[t._v("#")]),t._v(" 3. Babel 配置中对 CommonJS 模块特殊配置，注意babel@6和bable@7的区别")]),t._v(" "),n("h3",{attrs:{id:"_4-webpack-4体系中，如果是公司内部的npm模块，明确无副作用的，标记-sideeffects"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4-webpack-4体系中，如果是公司内部的npm模块，明确无副作用的，标记-sideeffects"}},[t._v("#")]),t._v(" 4. webpack@4体系中，如果是公司内部的npm模块，明确无副作用的，标记 sideEffects")])])}),[],!1,null,null,null);s.default=e.exports}}]);