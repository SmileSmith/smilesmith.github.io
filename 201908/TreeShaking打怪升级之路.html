<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tree-Shaking进阶之路 | 前路漫漫</title>
    <meta name="description" content="前路漫漫 当克己 当慎独">
    
    
    <link rel="preload" href="/assets/css/0.styles.6dd12250.css" as="style"><link rel="preload" href="/assets/js/app.0623bd66.js" as="script"><link rel="preload" href="/assets/js/2.5dd5749f.js" as="script"><link rel="preload" href="/assets/js/7.c30685e8.js" as="script"><link rel="prefetch" href="/assets/js/10.fc6c68bf.js"><link rel="prefetch" href="/assets/js/11.ba650025.js"><link rel="prefetch" href="/assets/js/12.c6bd3826.js"><link rel="prefetch" href="/assets/js/13.65bc4a49.js"><link rel="prefetch" href="/assets/js/14.91612579.js"><link rel="prefetch" href="/assets/js/15.d9728f90.js"><link rel="prefetch" href="/assets/js/16.0cdff337.js"><link rel="prefetch" href="/assets/js/17.9b49432d.js"><link rel="prefetch" href="/assets/js/18.c6c32b37.js"><link rel="prefetch" href="/assets/js/19.d06222f2.js"><link rel="prefetch" href="/assets/js/20.8888a134.js"><link rel="prefetch" href="/assets/js/21.e7f0e2c3.js"><link rel="prefetch" href="/assets/js/22.1e32b4b7.js"><link rel="prefetch" href="/assets/js/23.2bdf04ee.js"><link rel="prefetch" href="/assets/js/24.2c3bbe4d.js"><link rel="prefetch" href="/assets/js/25.d1292960.js"><link rel="prefetch" href="/assets/js/26.6cabc15b.js"><link rel="prefetch" href="/assets/js/27.0d0f2ae0.js"><link rel="prefetch" href="/assets/js/28.d8f98424.js"><link rel="prefetch" href="/assets/js/3.1a1f1fe3.js"><link rel="prefetch" href="/assets/js/4.7d273734.js"><link rel="prefetch" href="/assets/js/5.e11c7487.js"><link rel="prefetch" href="/assets/js/6.3195bf77.js"><link rel="prefetch" href="/assets/js/8.8adcad81.js"><link rel="prefetch" href="/assets/js/9.f7bc9cde.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6dd12250.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/images/logo.png" alt="前路漫漫" class="logo"> <span class="site-name can-hide">前路漫漫</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">所有博客</a></div><div class="nav-item"><a href="http://gofrontend.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人网站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/SmileSmith/Blogs" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">所有博客</a></div><div class="nav-item"><a href="http://gofrontend.cn" target="_blank" rel="noopener noreferrer" class="nav-link external">
  个人网站
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/SmileSmith/Blogs" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Tree-Shaking进阶之路</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/201908/TreeShaking%E6%89%93%E6%80%AA%E5%8D%87%E7%BA%A7%E4%B9%8B%E8%B7%AF.html#一、什么是-tree-shaking？" class="sidebar-link">一、什么是 Tree-Shaking？</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/201908/TreeShaking%E6%89%93%E6%80%AA%E5%8D%87%E7%BA%A7%E4%B9%8B%E8%B7%AF.html#二、如何使用-tree-shaking？" class="sidebar-link">二、如何使用 Tree-Shaking？</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/201908/TreeShaking%E6%89%93%E6%80%AA%E5%8D%87%E7%BA%A7%E4%B9%8B%E8%B7%AF.html#三、tree-shaking-和-commonjsmodule" class="sidebar-link">三、Tree-Shaking 和 CommonJSModule</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/201908/TreeShaking%E6%89%93%E6%80%AA%E5%8D%87%E7%BA%A7%E4%B9%8B%E8%B7%AF.html#四、tree-shaking-和-babel，鱼和熊掌可以兼得" class="sidebar-link">四、Tree-Shaking 和 Babel，鱼和熊掌可以兼得</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/201908/TreeShaking%E6%89%93%E6%80%AA%E5%8D%87%E7%BA%A7%E4%B9%8B%E8%B7%AF.html#_4-1-babel-对-esmodule-模块的处理" class="sidebar-link">4.1 Babel 对 ESModule 模块的处理</a></li><li class="sidebar-sub-header"><a href="/201908/TreeShaking%E6%89%93%E6%80%AA%E5%8D%87%E7%BA%A7%E4%B9%8B%E8%B7%AF.html#_4-2-cjs和es混用导致-babel-transform-runtime-异常" class="sidebar-link">4.2 cjs和es混用导致 babel-transform-runtime 异常</a></li></ul></li><li><a href="/201908/TreeShaking%E6%89%93%E6%80%AA%E5%8D%87%E7%BA%A7%E4%B9%8B%E8%B7%AF.html#五、tree-shaking-和-sideeffect，锦上添花" class="sidebar-link">五、Tree-Shaking 和 SideEffect，锦上添花</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/201908/TreeShaking%E6%89%93%E6%80%AA%E5%8D%87%E7%BA%A7%E4%B9%8B%E8%B7%AF.html#六、tree-shaking-和-sourcemap，我全都要" class="sidebar-link">六、Tree-Shaking 和 SourceMap，我全都要</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/201908/TreeShaking%E6%89%93%E6%80%AA%E5%8D%87%E7%BA%A7%E4%B9%8B%E8%B7%AF.html#七、web项目中使用tree-shaking的实践建议" class="sidebar-link">七、web项目中使用Tree-Shaking的实践建议</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/201908/TreeShaking%E6%89%93%E6%80%AA%E5%8D%87%E7%BA%A7%E4%B9%8B%E8%B7%AF.html#_1-非node体系的代码尽量使用esmodule" class="sidebar-link">1. 非Node体系的代码尽量使用ESModule</a></li><li class="sidebar-sub-header"><a href="/201908/TreeShaking%E6%89%93%E6%80%AA%E5%8D%87%E7%BA%A7%E4%B9%8B%E8%B7%AF.html#_2-编写-esmodule-代码，有多个非强耦合的导出内容时，尽量使用命名导出-按需导入" class="sidebar-link">2. 编写 ESModule 代码，有多个非强耦合的导出内容时，尽量使用命名导出/按需导入</a></li><li class="sidebar-sub-header"><a href="/201908/TreeShaking%E6%89%93%E6%80%AA%E5%8D%87%E7%BA%A7%E4%B9%8B%E8%B7%AF.html#_3-babel-配置中对-commonjs-模块特殊配置，注意babel-6和bable-7的区别" class="sidebar-link">3. Babel 配置中对 CommonJS 模块特殊配置，注意babel@6和bable@7的区别</a></li><li class="sidebar-sub-header"><a href="/201908/TreeShaking%E6%89%93%E6%80%AA%E5%8D%87%E7%BA%A7%E4%B9%8B%E8%B7%AF.html#_4-webpack-4体系中，如果是公司内部的npm模块，明确无副作用的，标记-sideeffects" class="sidebar-link">4. webpack@4体系中，如果是公司内部的npm模块，明确无副作用的，标记 sideEffects</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="tree-shaking进阶之路"><a href="#tree-shaking进阶之路" class="header-anchor">#</a> Tree-Shaking进阶之路</h1> <h2 id="一、什么是-tree-shaking？"><a href="#一、什么是-tree-shaking？" class="header-anchor">#</a> 一、什么是 Tree-Shaking？</h2> <p>在<a href="https://webpack.js.org/guides/tree-shaking/" target="_blank" rel="noopener noreferrer">webpack官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>的定义是: Tree-Shaking 用于移除 JavaScript 上下文中的未引用代码「dead-code」。在 webpack 中，基于 ES2015 模块（也叫做 <strong>harmony</strong> 模块）的静态分析能力，确定模块之间的依赖关系，进而找出不需要的依赖，在构建阶段就删除不需要的依赖。</p> <p>在实际业务开发中，我们往往会引入许多npm包，为了加快用户下载脚本的大小和时间，一般情况下我们都会利用 Tree-Shaking 的特性来减小打包后代码的体积。</p> <p><img src="/assets/img/7.f55bbd5e.png" alt="01.No-Tree-Shaking"></p> <p><img src="/assets/img/6.7fd99528.png" alt="02.With-Tree-Shaking"></p> <h2 id="二、如何使用-tree-shaking？"><a href="#二、如何使用-tree-shaking？" class="header-anchor">#</a> 二、如何使用 Tree-Shaking？</h2> <ol><li>代码中使用 ESModule，在导入时使用按需导入的语法 <code>import { foo, bar } from './ESModule';</code></li> <li>webpack中没有编译器把 ESModule 转换成 CommonJSModule</li> <li>webpack默认会进行 Tree-Shaking，标记未被使用的导出内容为 <strong>unused harmony export</strong></li> <li>配置uglifyJS等webpack代码压缩插件会删掉 被webpack标记为 <strong>unused harmony export</strong>的代码</li></ol> <p><em>// webpack@4.x中已经弃用单独配置uglifyJSPlugin的方式，第4点修改为配置mode=production</em></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// in index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> foo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./es'</span><span class="token punctuation">;</span>

<span class="token comment">// in webpack.config.js in webpack@2@3</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token keyword">new</span> <span class="token class-name">UglifyJsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>sourceMap<span class="token operator">:</span><span class="token boolean">true</span><span class="token punctuation">,</span> compress<span class="token operator">:</span> <span class="token punctuation">{</span>warnings<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token comment">// in webpack.config.js in webpack@4</span>
    mode<span class="token operator">:</span> <span class="token string">'production'</span><span class="token punctuation">,</span>
</code></pre></div><h2 id="三、tree-shaking-和-commonjsmodule"><a href="#三、tree-shaking-和-commonjsmodule" class="header-anchor">#</a> 三、Tree-Shaking 和 CommonJSModule</h2> <p>在上面已经提到: Tree-Shaking 是基于静态模块分析的，因此对于 CommonJS 规范的JS模块，Tree-Shaking 不会生效，webpack 在打包时会全量打包至 chunk 里。</p> <h2 id="四、tree-shaking-和-babel，鱼和熊掌可以兼得"><a href="#四、tree-shaking-和-babel，鱼和熊掌可以兼得" class="header-anchor">#</a> 四、Tree-Shaking 和 Babel，鱼和熊掌可以兼得</h2> <p>这里 Babel 和 Tree-Shaking 又有什么关系呢？</p> <p>在实际的web业务中，我们很难要求用户使用完整支持ES6的浏览器，我们一般会利用 babel-loader 将ES6源码转换成浏览器可解析的JS。</p> <p>问题的答案是 babel-preset-env 中有一项默认配置： <code>module: 'cjs'</code>。这项配置的作用是：<code>babel对ESModule的转换方式</code>，默认的cjs会把源码中所有的ESModule转换成CommonJSModule！！！</p> <h3 id="_4-1-babel-对-esmodule-模块的处理"><a href="#_4-1-babel-对-esmodule-模块的处理" class="header-anchor">#</a> 4.1 Babel 对 ESModule 模块的处理</h3> <p>首先，是动态模块和静态模块的问题，静态模块可以转换成动态模块，反之则不能。</p> <ul><li>static(es) --&gt; dynamic(cjs) ✅</li> <li>dynamic(cjs) -/-&gt; static(es) ❌</li></ul> <p>babel在设计时可能考虑到了这个因素: 既然代码中可能混杂cjs和es，并且cjs不能转换成es，那就默认把所有es转换成cjs，准没错。</p> <p>此外，babel-preset-env提供了<code>module</code>的配置，我们可以配置<code>module: false</code>，让babel不转换 ESModule，这样webpack中Tree-Shaking就可以正常工作</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    loader<span class="token operator">:</span> <span class="token string">&quot;babel-loader&quot;</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> <span class="token punctuation">{</span>
        presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span><span class="token punctuation">{</span> modules<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;stage-2&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

</code></pre></div><h3 id="_4-2-cjs和es混用导致-babel-transform-runtime-异常"><a href="#_4-2-cjs和es混用导致-babel-transform-runtime-异常" class="header-anchor">#</a> 4.2 cjs和es混用导致 babel-transform-runtime 异常</h3> <p>我们知道，Babel 在转换ES5以上的语法时会需要一些polyfill，比如es-class。</p> <ul><li>如果不做特别处理，Babel 会把每个class都转换成完整的ES5-class实现，产生很多冗余代码</li> <li>如果用全局polyfill，会污染全局上下文，并且需要手动需要哪些polyfill，比较繁琐</li></ul> <p>babel-transform-runtime 可以解决上面提到问题：它会在用到 es-class 的模块中 <code>import</code> 一个公共的 class-helper 实现。这样就以最小的体积代价，只影响需要 polyfill 的JS模块。详情可阅读：<a href="https://babeljs.io/docs/en/babel-plugin-transform-runtime#why" target="_blank" rel="noopener noreferrer">why babel-transfrom-runtime<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    loader<span class="token operator">:</span> <span class="token string">&quot;babel-loader&quot;</span><span class="token punctuation">,</span>
    options<span class="token operator">:</span> <span class="token punctuation">{</span>
        presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span><span class="token punctuation">{</span> modules<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;stage-2&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>
        plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;transform-runtime&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p><img src="/assets/img/3.947f9dac.jpg" alt="polyfill"></p> <p>关于 Tree-Shaking 的问题在哪里？</p> <p>当你的项目中有混用 ESModule 和 CommonJSModule 的时候，有可能触发一个配置冲突问题。在说明这个问题之间我们前置两个技术点：</p> <ol><li>上面提到，babel-transfrom-runtime 会往需要 polyfill 的模块中 <strong>导入</strong> polyfill代码。</li> <li>现代JS编译器，对于JS模块的解析，如果代码中出现 import 或者 export，它就被当作 ESModule。在 ESModule 中 module 是保留字，不允许任何操作，比如<code>module.exports = xxx</code>会报如下错误：</li></ol> <div class="language-bash extra-class"><pre class="language-bash"><code>// <span class="token keyword">in</span> terminal wepack error: js模块错误导致模块解析错误
WARNING <span class="token keyword">in</span> ./index.js
<span class="token builtin class-name">export</span> <span class="token string">'promise'</span> <span class="token punctuation">(</span>imported as <span class="token string">'CommonJSModule'</span><span class="token punctuation">)</span> was not found <span class="token keyword">in</span> <span class="token string">'./cjs.js'</span>

// <span class="token keyword">in</span> browser <span class="token function">open</span> js error: 具体js错误
Cannot assign to <span class="token builtin class-name">read</span> only property <span class="token string">'exports'</span> of object <span class="token string">'#&lt;Object&gt;'</span>
</code></pre></div><p>当满足以下条件时，transform-runtime<strong>往CommonJS模块中import导入polyfill</strong>，就会出现上面的错误：</p> <ol><li>使用4.2中所示的Babel配置: <code>modules:false &amp;&amp; babel-plugin-transform-runtime</code></li> <li>在ESModule中导入CommonJSModule的行为</li> <li>CommonJSModule中有需要polyfill的代码（如使用ES6 class语法）</li></ol> <p>分析结果是cjs和es混用的项目中，直接配置<code>modules:false</code>和<code>babel-plugin-transform-runtime</code>是有冲突的</p> <ul><li><p>如果仅有<code>module:false</code>，transform-runtime往CommonJSModule中导入polyfill会使用reqire的方式，不会报错。但是会导致其它ESModule在webpack中的 Tree-Shaking 失效😢</p></li> <li><p>如果仅有transform-runtime，就不会有有polyfill导入，CommonJSModule 原样输出，被webpack当作 CommonJS 模块，不会报错。但是没有 transform-runtime，想使用新的语法就得用全局导入 babel-polyfill 的方式😢</p></li></ul> <p><img src="/assets/img/4.6844779b.jpg" alt="harmony-import"></p> <p>解决之法是针对ESModule和CommonJS模块分别配置babel处理的方式，详情见<a href="https://github.com/babel/babel/issues/9238" target="_blank" rel="noopener noreferrer">babel/issues/9238<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>rules<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
    test<span class="token operator">:</span> <span class="token regex">/cjs\.js$/</span><span class="token punctuation">,</span>
    use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        loader<span class="token operator">:</span> <span class="token string">&quot;babel-loader&quot;</span><span class="token punctuation">,</span>
        options<span class="token operator">:</span> <span class="token punctuation">{</span>
            presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> modules<span class="token operator">:</span> <span class="token string">&quot;commonjs&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;stage-2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;transform-runtime&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            cacheDirectory<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
            <span class="token comment">// CommonJS规范的使用sourceType: &quot;script&quot;</span>
            sourceType<span class="token operator">:</span> <span class="token string">&quot;script&quot;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">{</span>
    test<span class="token operator">:</span> <span class="token regex">/(es|index)\.js$/</span><span class="token punctuation">,</span>
    use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        loader<span class="token operator">:</span> <span class="token string">&quot;babel-loader&quot;</span><span class="token punctuation">,</span>
        options<span class="token operator">:</span> <span class="token punctuation">{</span>
            presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">&quot;env&quot;</span><span class="token punctuation">,</span><span class="token punctuation">{</span> modules<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">&quot;stage-2&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;transform-runtime&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token comment">// ES规范的使用sourceType: &quot;module&quot;（默认值）</span>
            sourceType<span class="token operator">:</span> <span class="token string">&quot;module&quot;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">]</span>

</code></pre></div><p><em>// babel@7.x中可以合并配置</em></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>rules<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex">/\.js$/</span><span class="token punctuation">,</span>
        exclude<span class="token operator">:</span> <span class="token regex">/node_modules/</span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">{</span>
                loader<span class="token operator">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
                options<span class="token operator">:</span> <span class="token punctuation">{</span>
                    presets<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token string">'@babel/preset-env'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> modules<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'@babel/plugin-transform-runtime'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
                    <span class="token comment">// babel@7新增unambiguous</span>
                    <span class="token comment">// transform-runtime可以自动识别模块类型，根据模块类型使用不同的“导入”</span>
                    sourceType<span class="token operator">:</span> <span class="token string">&quot;unambiguous&quot;</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">]</span><span class="token punctuation">,</span>

</code></pre></div><h2 id="五、tree-shaking-和-sideeffect，锦上添花"><a href="#五、tree-shaking-和-sideeffect，锦上添花" class="header-anchor">#</a> 五、Tree-Shaking 和 SideEffect，锦上添花</h2> <p>SideEffect 是 webpack@v4 的重要特性之一，是 Tree-Shaking 的重要补充，可以让 webpack 更好地进行无用代码的剥离。</p> <p>即使依赖的npm包的 package.json 中没有标记 sideEffects，Tree-Shaking 过程中也会利用<a href="https://github.com/terser-js/terser" target="_blank" rel="noopener noreferrer">terser<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>来分析模中的副作用来判断哪些代码可以优化掉。然而因为JS语言天生的动态性，terser对副作用的判断很难做到非常准确，多数情况下它的工作还是表保守。因此需要编写npm包的作者自己来定义自己包中的副作用。</p> <p><em>&quot;副作用&quot;定义是：导入时就执行的特定行为的代码，而不是默认导出或多个命名导出。一个典型例子是polyfills，它会影响全局，但通常不在模块中导出。</em></p> <p>比如我们编写了1个Button组件，并准备发布npm包。如果确认该包下没有任何副作用的代码，就可以在 packeage.json 标记 sideEffects 为false。webpack在处理该模块时，会忽略所有非导出的内容。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@my-ui/Button&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;sideEffects&quot;</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>再比如我们编写了1个Layout组件，并准备发布npm包。如果确认该包下某个未被引用的 reset.css 有全局作用（副作用），就可以在 packeage.json 设置 sideEffects 值为该css文件的相对路径。webpack 在处理该模块时，会忽略非导出的内容，而该 reset.css 还会被打包进来。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
    <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;@my-ui/Button&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;sideEffects&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;./reset.css&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>更多可参考官方文档：<a href="https://webpack.js.org/guides/tree-shaking/#clarifying-tree-shaking-and-sideeffects" target="_blank" rel="noopener noreferrer">clarifying-tree-shaking-and-sideeffects<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h2 id="六、tree-shaking-和-sourcemap，我全都要"><a href="#六、tree-shaking-和-sourcemap，我全都要" class="header-anchor">#</a> 六、Tree-Shaking 和 SourceMap，我全都要</h2> <p>有同学要问了：如果 Tree-Shaking 把无用代码删除后，还能在SourceMap 帮助下看到相关的源码吗？</p> <p>答案是可以的：</p> <p><img src="/assets/img/5.9998e317.jpg" alt="source-map"></p> <h2 id="七、web项目中使用tree-shaking的实践建议"><a href="#七、web项目中使用tree-shaking的实践建议" class="header-anchor">#</a> 七、web项目中使用Tree-Shaking的实践建议</h2> <h3 id="_1-非node体系的代码尽量使用esmodule"><a href="#_1-非node体系的代码尽量使用esmodule" class="header-anchor">#</a> 1. 非Node体系的代码尽量使用ESModule</h3> <p>CommonJSModule 的动态性和 ESModule 的静态特是实际应用中平衡取舍的形成的，没绝对的好坏。当然，如果你的模块只在web端使用（无node的应用场景），且没有用到动态导入、条件导入的特性，建议使用 ESModule 规范来模块化你的代码。</p> <h3 id="_2-编写-esmodule-代码，有多个非强耦合的导出内容时，尽量使用命名导出-按需导入"><a href="#_2-编写-esmodule-代码，有多个非强耦合的导出内容时，尽量使用命名导出-按需导入" class="header-anchor">#</a> 2. 编写 ESModule 代码，有多个非强耦合的导出内容时，尽量使用命名导出/按需导入</h3> <h3 id="_3-babel-配置中对-commonjs-模块特殊配置，注意babel-6和bable-7的区别"><a href="#_3-babel-配置中对-commonjs-模块特殊配置，注意babel-6和bable-7的区别" class="header-anchor">#</a> 3. Babel 配置中对 CommonJS 模块特殊配置，注意babel@6和bable@7的区别</h3> <h3 id="_4-webpack-4体系中，如果是公司内部的npm模块，明确无副作用的，标记-sideeffects"><a href="#_4-webpack-4体系中，如果是公司内部的npm模块，明确无副作用的，标记-sideeffects" class="header-anchor">#</a> 4. webpack@4体系中，如果是公司内部的npm模块，明确无副作用的，标记 sideEffects</h3></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/SmileSmith/Blogs/edit/master/docs/201908/TreeShaking打怪升级之路.md" target="_blank" rel="noopener noreferrer">帮助改善此页面！</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">最后更新:</span> <span class="time">12/29/2019, 11:32:53 AM</span></div></footer> <!----> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.0623bd66.js" defer></script><script src="/assets/js/2.5dd5749f.js" defer></script><script src="/assets/js/7.c30685e8.js" defer></script>
  </body>
</html>
